AWSTemplateFormatVersion: '2010-09-09'
Description: 1BU Demo Portfolio for Service Catalog. (fdp-1p4da46nc)
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Portfolio Information
        Parameters:
          - PortfolioName
          - PortfolioProvider
          - PortfolioDescription
      - Label:
          default: IAM Settings
        Parameters:
          - LinkedRole1
          - LinkedRole2
          - LaunchRoleName
      - Label:
          default: Product Settings
        Parameters:
          - RepoRootURL
Parameters:
  PortfolioProvider:
    Type: String
    Description: Provider Name
    Default: ITS Cloud Support
  PortfolioName:
    Type: String
    Description: Portfolio Name
    Default: Service Catalog 1BU Reference Architecture
  PortfolioDescription:
    Type: String
    Description: Portfolio Description
    Default: Service Catalog Portfolio that contains reference architecture products for 1BU demo.
  LaunchRoleName:
    Type: String
    Description: (Optional) Name of the launch constraint role for 1BU products. leave this blank to create the role.
  LinkedRole1:
    Type: String
    Description: (Optional) The name of a role which can execute products in this portfolio.
  LinkedRole2:
    Type: String
    Description: (Optional) The name of a second role which can execute products in this portfolio.
  RepoRootURL:
    Type: String
    Description: S3 root url for the repository containing the product templates.
    Default: https://s3.amazonaws.com/service-catalog-testing-314628052097/
Conditions:
  CreateLaunchConstraint: !Equals 
    - !Ref LaunchRoleName
    - ''
  CondLinkRole1: !Not 
    - !Equals 
      - !Ref LinkedRole1
      - ''
  CondLinkRole2: !Not 
    - !Equals 
      - !Ref LinkedRole2
      - ''
Resources:
  SC1BUportfolio:
    Type: AWS::ServiceCatalog::Portfolio
    Properties:
      ProviderName: !Ref PortfolioProvider
      Description: !Ref PortfolioDescription
      DisplayName: !Ref PortfolioName
  addrole1:
    Type: AWS::ServiceCatalog::PortfolioPrincipalAssociation
    Condition: CondLinkRole1
    Properties:
      PrincipalARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/${LinkedRole1}'
      PortfolioId: !Ref SC1BUportfolio
      PrincipalType: IAM
  addrole2:
    Type: AWS::ServiceCatalog::PortfolioPrincipalAssociation
    Condition: CondLinkRole2
    Properties:
      PrincipalARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/${LinkedRole2}'
      PortfolioId: !Ref SC1BUportfolio
      PrincipalType: IAM
  LaunchConstraintRole:
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Type: AWS::CloudFormation::Stack
    Condition: CreateLaunchConstraint
    Properties:
      TemplateURL: !Sub '${RepoRootURL}iam/sc-1bu-templates-launchrole.yml'
      TimeoutInMinutes: 5
  1butemplateproduct1:
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        PortfolioProvider: !Ref PortfolioProvider
        LaunchConstraintRole: !If 
          - CreateLaunchConstraint
          - !GetAtt 
            - LaunchConstraintRole
            - Outputs.LaunchRoleName
          - !Ref LaunchRoleName
        PortfolioId: !Ref SC1BUportfolio
        RepoRootURL: !Ref RepoRootURL
      TemplateURL: !Sub '${RepoRootURL}1bu-templates/sc-product-serverless-monitoring.yml'
      TimeoutInMinutes: 5
Outputs:
  LaunchConstraintRoleARN:
    Condition: CreateLaunchConstraint
    Value: !GetAtt 
      - LaunchConstraintRole
      - Outputs.LaunchRoleArn
  LaunchConstraintRoleName:
    Condition: CreateLaunchConstraint
    Value: !GetAtt 
      - LaunchConstraintRole
      - Outputs.LaunchRoleName
  1buProductId:
    Value: !GetAtt 
      - 1butemplateproduct1
      - Outputs.ProductId
