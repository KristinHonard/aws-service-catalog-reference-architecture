AWSTemplateFormatVersion: '2010-09-09'
Description: This template will create a VPC with 4 Dual-Stack Public Subnets, 4  Dual-Stack Private Subnets,4 IPv6 Only subents, and 2 NAT Gateway.
Metadata:
  AWS::CloudFormation::Interface:
#=======================================================
# Parameter Groups
#=======================================================

    ParameterGroups:
      - Label:
          default: VPC Configuration
        Parameters:
          - VPCCIDR
      - Label:
          default: Public Subnet Configuration
        Parameters:
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - PublicSubnet3CIDR 
          - PublicSubnet4CIDR           
      - Label:
          default: Private Subnet Configuration
        Parameters:
          - PrivateSubnet1CIDR
          - PrivateSubnet2CIDR
          - PrivateSubnet3CIDR   
          - PrivateSubnet4CIDR        
      - Label:
          default:  Resource naming
        Parameters:
          - ResourcePrefix
        

#=======================================================
# Parameter Labels
#=======================================================

    ParameterLabels:
      PrivateSubnet1CIDR:
        default: Private subnet 1 CIDR
      PrivateSubnet2CIDR:
        default: Private subnet 2 CIDR   
      PrivateSubnet3CIDR:
        default: Private subnet 3 CIDR  
      PrivateSubnet4CIDR:
        default: Private subnet 4 CIDR                   
      PublicSubnet1CIDR:
        default: Public subnet 1 CIDR
      PublicSubnet2CIDR:
        default: Public subnet 2 CIDR   
      PublicSubnet3CIDR:
        default: Public subnet 3 CIDR    
      PublicSubnet4CIDR:
        default: Public subnet 4 CIDR                   
      VPCCIDR:
        default: VPC CIDR
      ResourcePrefix:
        default: Prefix assigned when naming resources


#=======================================================
# Parameters
#=======================================================

Parameters:
  ResourcePrefix:
    Type: String
    Description: Prefix for the created resources (e.g. default-Public-Subnet1, default-Private-Subnet1, etc...).
    Default: 'Default'

  VPCCIDR:
    Type: String
    Description: CIDR block for the VPC.
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    MinLength: 9
    MaxLength: 18
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x

  PublicSubnet1CIDR:    
    Type: String
    Description: CIDR block for the public DMZ subnet 1 located in Availability Zone "use1-az1".
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    MinLength: 9
    MaxLength: 18
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x    

  PublicSubnet2CIDR:    
    Type: String
    Description: CIDR block for the public DMZ subnet 2 located in Availability Zone "use1-az2".
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    MinLength: 9
    MaxLength: 18
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x    

  PublicSubnet3CIDR:    
    Type: String
    Description: CIDR block for the public DMZ subnet 3 located in Availability Zone "use1-az3".
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    MinLength: 9
    MaxLength: 18
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x  

  PublicSubnet4CIDR:    
    Type: String
    Description: CIDR block for the public DMZ subnet 4 located in Availability Zone "use1-az4".
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    MinLength: 9
    MaxLength: 18
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x  


  PrivateSubnet1CIDR:
    Type: String
    Description: CIDR block for the private subnet 1 located in Availability Zone "use1-az1".
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    MinLength: 9
    MaxLength: 18
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x    

  PrivateSubnet2CIDR:
    Type: String
    Description: CIDR block for the private subnet 2 located in Availability Zone "use1-az2".
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    MinLength: 9
    MaxLength: 18
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x  

  PrivateSubnet3CIDR:
    Type: String
    Description: CIDR block for the private subnet 3 located in Availability Zone "use1-az3".
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    MinLength: 9
    MaxLength: 18
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x 

  PrivateSubnet4CIDR:
    Type: String
    Description: CIDR block for the private subnet 4 located in Availability Zone "use1-az4".
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    MinLength: 9
    MaxLength: 18
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x 


#=======================================================
# Conditions
#=======================================================

Conditions:
  NVirginiaRegionCondition: !Equals [!Ref 'AWS::Region', us-east-1]


Resources:

# =======================================================
# Base VPC
# =======================================================

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref 'VPCCIDR'
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-VPC

  IPV6VPCCidrBlock:
    Type: AWS::EC2::VPCCidrBlock
    Properties:
        AmazonProvidedIpv6CidrBlock: true
        VpcId: !Ref VPC

# # =======================================================
# # VPC Block Public Access (BPA) options and exclusion list
# # =======================================================
  
    VPCBlockPublicAccessExclusion1:
    DependsOn: NATGateway1
    Type: AWS::EC2::VPCBlockPublicAccessExclusion
    Properties:
      InternetGatewayExclusionMode: allow-bidirectional
      SubnetId: !Ref 'PublicSubnet1'
        

  VPCBlockPublicAccessExclusion2:
    DependsOn: NATGateway1
    Type: AWS::EC2::VPCBlockPublicAccessExclusion
    Properties:
      InternetGatewayExclusionMode: allow-bidirectional
      SubnetId: !Ref 'PublicSubnet2'


 VPCBlockPublicAccessExclusion3:
    DependsOn: NATGateway1
    Type: AWS::EC2::VPCBlockPublicAccessExclusion
    Properties:
      InternetGatewayExclusionMode: allow-bidirectional
      SubnetId: !Ref 'PublicSubnet3'


 VPCBlockPublicAccessExclusion4:
    DependsOn: NATGateway1
    Type: AWS::EC2::VPCBlockPublicAccessExclusion
    Properties:
      InternetGatewayExclusionMode: allow-bidirectional
      SubnetId: !Ref 'PublicSubnet4'


# =======================================================
# DHCP Options
# =======================================================

  DHCPOptions:
    Type: AWS::EC2::DHCPOptions
    Properties:
      DomainName: !If [NVirginiaRegionCondition, ec2.internal, !Join ['', [!Ref 'AWS::Region',
            .compute.internal]]]
      DomainNameServers:
        - AmazonProvidedDNS
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DHCPOptionsSet

  VPCDHCPOptionsAssociation:
    Type: AWS::EC2::VPCDHCPOptionsAssociation
    Properties:
      VpcId: !Ref 'VPC'
      DhcpOptionsId: !Ref 'DHCPOptions'



# =======================================================
# Internet Gateway and Egress Only Internet Gateway
# =======================================================

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-InternetGateway
        - Key: Network
          Value: Public

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref 'VPC'
      InternetGatewayId: !Ref 'InternetGateway'

  IPv6InternetGateway:
    Type: AWS::EC2::EgressOnlyInternetGateway
    Properties: 
        VpcId: !Ref VPC

# =======================================================
# Dual-Stack Private Subnets
# =======================================================

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: !Ref 'PrivateSubnet1CIDR'
      AvailabilityZoneId: use1-az1
      Ipv6CidrBlock: !Select [ 0, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      AssignIpv6AddressOnCreation: true
      PrivateDnsNameOptionsOnLaunch:
        EnableResourceNameDnsAAAARecord: true
        EnableResourceNameDnsARecord: true
        HostnameType: ip-name
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PrivateSubnet1


  PrivateSubnet2:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: !Ref 'PrivateSubnet2CIDR'
      AvailabilityZoneId: use1-az2
      Ipv6CidrBlock: !Select [ 1, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      AssignIpv6AddressOnCreation: true
      PrivateDnsNameOptionsOnLaunch:
        EnableResourceNameDnsAAAARecord: true
        EnableResourceNameDnsARecord: true
        HostnameType: ip-name
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PrivateSubnet2


  PrivateSubnet3:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: !Ref 'PrivateSubnet3CIDR'
      AvailabilityZoneId: use1-az3
      Ipv6CidrBlock: !Select [ 2, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      AssignIpv6AddressOnCreation: true
      PrivateDnsNameOptionsOnLaunch:
        EnableResourceNameDnsAAAARecord: true
        EnableResourceNameDnsARecord: true
        HostnameType: ip-name
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PrivateSubnet3


  PrivateSubnet4:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: !Ref 'PrivateSubnet4CIDR'
      AvailabilityZoneId: use1-az4
      Ipv6CidrBlock: !Select [ 3, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      AssignIpv6AddressOnCreation: true
      PrivateDnsNameOptionsOnLaunch:
        EnableResourceNameDnsAAAARecord: true
        EnableResourceNameDnsARecord: true
        HostnameType: ip-name
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PrivateSubnet4

# =======================================================
# Dual-Stack Private Subnets routes and route tables
# =======================================================

  PrivateSubnet1RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PrivateSubnet1RouteTable

  PrivateSubnet1NATRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'PrivateSubnet1RouteTable'
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref 'NATGateway1'

  PrivateSubnet1EIGWRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'PrivateSubnet1RouteTable'
      DestinationIpv6CidrBlock: '::/0'
      EgressOnlyInternetGatewayId: !Ref 'IPv6InternetGateway'

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PrivateSubnet1'
      RouteTableId: !Ref 'PrivateSubnet1RouteTable'

  PrivateSubnet2RouteTable:    
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PrivateSubnet2RouteTable

  PrivateSubnet2NATRoute:    
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref 'PrivateSubnet2RouteTable'
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref 'NATGateway1'

  PrivateSubnet2EIGWRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'PrivateSubnet2RouteTable'
      DestinationIpv6CidrBlock: '::/0'
      EgressOnlyInternetGatewayId: !Ref 'IPv6InternetGateway'

  PrivateSubnet2RouteTableAssociation:    
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PrivateSubnet2'
      RouteTableId: !Ref 'PrivateSubnet2RouteTable'

  PrivateSubnet3RouteTable:    
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PrivateSubnet3RouteTable

  PrivateSubnet3NATRoute:    
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref 'PrivateSubnet3RouteTable'
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref 'NATGateway2'

  PrivateSubnet3EIGWRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'PrivateSubnet3RouteTable'
      DestinationIpv6CidrBlock: '::/0'
      EgressOnlyInternetGatewayId: !Ref 'IPv6InternetGateway'

  PrivateSubnet3RouteTableAssociation:    
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PrivateSubnet3'
      RouteTableId: !Ref 'PrivateSubnet3RouteTable'


  PrivateSubnet4RouteTable:    
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PrivateSubnet4RouteTable

  PrivateSubnet4NATRoute:    
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref 'PrivateSubnet4RouteTable'
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref 'NATGateway2'

  PrivateSubnet4EIGWRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'PrivateSubnet4RouteTable'
      DestinationIpv6CidrBlock: '::/0'
      EgressOnlyInternetGatewayId: !Ref 'IPv6InternetGateway'

  PrivateSubnet4RouteTableAssociation:    
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PrivateSubnet4'
      RouteTableId: !Ref 'PrivateSubnet4RouteTable'


# =======================================================
# Dual-Stack Public Subnets
# =======================================================

  PublicSubnet1:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: !Ref 'PublicSubnet1CIDR'
      Ipv6CidrBlock: !Select [ 4, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      AvailabilityZoneId: use1-az1
      MapPublicIpOnLaunch: false
      AssignIpv6AddressOnCreation: true
      PrivateDnsNameOptionsOnLaunch:
        EnableResourceNameDnsAAAARecord: true
        EnableResourceNameDnsARecord: true
        HostnameType: ip-name
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PublicSubnet1

  PublicSubnet2:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: !Ref 'PublicSubnet2CIDR'
      Ipv6CidrBlock: !Select [ 5, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      AvailabilityZoneId: use1-az2
      AssignIpv6AddressOnCreation: true
      MapPublicIpOnLaunch: false
      PrivateDnsNameOptionsOnLaunch:
        EnableResourceNameDnsAAAARecord: true
        EnableResourceNameDnsARecord: true
        HostnameType: ip-name
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PublicSubnet2

  PublicSubnet3:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: !Ref 'PublicSubnet3CIDR'
      Ipv6CidrBlock: !Select [ 6, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      AvailabilityZoneId: use1-az3
      AssignIpv6AddressOnCreation: true
      MapPublicIpOnLaunch: false
      PrivateDnsNameOptionsOnLaunch:
        EnableResourceNameDnsAAAARecord: true
        EnableResourceNameDnsARecord: true
        HostnameType: ip-name
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PublicSubnet3

  PublicSubnet4:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: !Ref 'PublicSubnet4CIDR'
      Ipv6CidrBlock: !Select [ 7, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      AvailabilityZoneId: use1-az4
      AssignIpv6AddressOnCreation: true
      MapPublicIpOnLaunch: false
      PrivateDnsNameOptionsOnLaunch:
        EnableResourceNameDnsAAAARecord: true
        EnableResourceNameDnsARecord: true
        HostnameType: ip-name
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PublicSubnet4


# =======================================================
# Dual-Stack Public Subnets routes and route tables
# =======================================================

  PublicSubnetRouteTable:    
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-DualStack-PublicSubnetsRouteTable

  PublicSubnetRoute:    
    DependsOn: VPCGatewayAttachment
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref 'PublicSubnetRouteTable'
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref 'InternetGateway'

  PublicSubnet2Route:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'PublicSubnetRouteTable'
      DestinationIpv6CidrBlock: '::/0'
      GatewayId: !Ref 'InternetGateway'

  PublicSubnet1RouteTableAssociation:    
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PublicSubnet1'
      RouteTableId: !Ref 'PublicSubnetRouteTable'

  PublicSubnet2RouteTableAssociation:    
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PublicSubnet2'
      RouteTableId: !Ref 'PublicSubnetRouteTable'

  PublicSubnet3RouteTableAssociation:    
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PublicSubnet3'
      RouteTableId: !Ref 'PublicSubnetRouteTable'

  PublicSubnet4RouteTableAssociation:    
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PublicSubnet4'
      RouteTableId: !Ref 'PublicSubnetRouteTable'


# =======================================================
# IPv6 Only Subnets
# =======================================================

  IPv6PrivateSubnet1:
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      AvailabilityZoneId: use1-az1
      Ipv6CidrBlock: !Select [ 8, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      Ipv6Native: true
      EnableDns64: true
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-IPv6Only-PrivateSubnet1

  IPv6PrivateSubnet2:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      AvailabilityZoneId: use1-az2
      Ipv6CidrBlock: !Select [ 9, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      Ipv6Native: true
      EnableDns64: true
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-IPv6Only-PrivateSubnet2

  IPv6PrivateSubnet3:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      AvailabilityZoneId: use1-az3
      Ipv6CidrBlock: !Select [ 10, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      Ipv6Native: true
      EnableDns64: true
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-IPv6Only-PrivateSubnet3


  IPv6PrivateSubnet4:    
    Type: AWS::EC2::Subnet
    DependsOn: IPV6VPCCidrBlock
    Properties:
      VpcId: !Ref 'VPC'
      AvailabilityZoneId: use1-az4
      Ipv6CidrBlock: !Select [ 11, !Cidr [ !Select [ 0, !GetAtt VPC.Ipv6CidrBlocks], 256, 64 ]]
      Ipv6Native: true
      EnableDns64: true
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-IPv6Only-PrivateSubnet4


# # =======================================================
# # IPv6 Private routes and route tables
# # =======================================================

  IPv6PrivateSubnet1RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-IPv6Only-PrivateSubnet1RouteTable

  IPv6PrivateSubnet1EIGWRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'IPv6PrivateSubnet1RouteTable'
      DestinationIpv6CidrBlock: '::/0'
      EgressOnlyInternetGatewayId: !Ref 'IPv6InternetGateway'

  IPv6PrivateSubnet1NatGatewayIdRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'IPv6PrivateSubnet1RouteTable'
      DestinationIpv6CidrBlock: '64:ff9b::/96'
      NatGatewayId: !Ref 'NATGateway1'

  IPv6PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'IPv6PrivateSubnet1'
      RouteTableId: !Ref 'IPv6PrivateSubnet1RouteTable'

  IPv6PrivateSubnet2RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-IPv6Only-PrivateSubnet2RouteTable

  IPv6PrivateSubnet2EIGWRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'IPv6PrivateSubnet2RouteTable'
      DestinationIpv6CidrBlock: '::/0'
      EgressOnlyInternetGatewayId: !Ref 'IPv6InternetGateway'

  IPv6PrivateSubnet2NatGatewayIdRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'IPv6PrivateSubnet2RouteTable'
      DestinationIpv6CidrBlock: '64:ff9b::/96'
      NatGatewayId: !Ref 'NATGateway1'

  IPv6PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'IPv6PrivateSubnet2'
      RouteTableId: !Ref 'IPv6PrivateSubnet2RouteTable'

  IPv6PrivateSubnet3RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-IPv6Only-PrivateSubnet3RouteTable

  IPv6PrivateSubnet3EIGWRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'IPv6PrivateSubnet3RouteTable'
      DestinationIpv6CidrBlock: '::/0'
      EgressOnlyInternetGatewayId: !Ref 'IPv6InternetGateway'

  IPv6PrivateSubnet3NatGatewayIdRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'IPv6PrivateSubnet3RouteTable'
      DestinationIpv6CidrBlock: '64:ff9b::/96'
      NatGatewayId: !Ref 'NATGateway2'

  IPv6PrivateSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'IPv6PrivateSubnet3'
      RouteTableId: !Ref 'IPv6PrivateSubnet3RouteTable'


  IPv6PrivateSubnet4RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-IPv6Only-PrivateSubnet4RouteTable

  IPv6PrivateSubnet4EIGWRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'IPv6PrivateSubnet4RouteTable'
      DestinationIpv6CidrBlock: '::/0'
      EgressOnlyInternetGatewayId: !Ref 'IPv6InternetGateway'

  IPv6PrivateSubnet4NatGatewayIdRoute:  
    Type: AWS::EC2::Route    
    Properties:
      RouteTableId: !Ref 'IPv6PrivateSubnet4RouteTable'
      DestinationIpv6CidrBlock: '64:ff9b::/96'
      NatGatewayId: !Ref 'NATGateway2'

  IPv6PrivateSubnet4RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'IPv6PrivateSubnet4'
      RouteTableId: !Ref 'IPv6PrivateSubnet4RouteTable'


# =======================================================
# NAT Gateway
# =======================================================

  NAT1EIP:    
    DependsOn: VPCGatewayAttachment
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NAT2EIP:    
    DependsOn: VPCGatewayAttachment
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc    


  NATGateway1:    
    DependsOn: VPCGatewayAttachment
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt 'NAT1EIP.AllocationId'
      SubnetId: !Ref 'PublicSubnet1'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-NATGateway1

  NATGateway2:    
    DependsOn: VPCGatewayAttachment
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt 'NAT2EIP.AllocationId'
      SubnetId: !Ref 'PublicSubnet2'
      Tags:
        - Key: Name
          Value: !Sub ${ResourcePrefix}-NATGateway2


#=======================================================
# Flow Logs
#=======================================================

  VPCFlowLogsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/Mathematica/${AWS::StackName}/${ResourcePrefix}-VPC/flowlogs"
      RetentionInDays: 90

  VPCFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub MathRole-${ResourcePrefix}-VPCFlowLogsRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - vpc-flow-logs.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: MathPolicy-CreateLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Effect: Allow
                Resource: !Sub "arn:aws:logs:${AWS::Region}:*:log-group:/Mathematica/${AWS::StackName}/${ResourcePrefix}-VPC/flowlogs:*"

  VPCFlowLog:
    Type: AWS::EC2::FlowLog
    Properties:
      DeliverLogsPermissionArn: !GetAtt "VPCFlowLogsRole.Arn"
      LogGroupName: !Sub "/Mathematica/${AWS::StackName}/${ResourcePrefix}-VPC/flowlogs"
      ResourceId: !Ref "VPC"
      ResourceType: VPC
      TrafficType: ALL

# =======================================================
# Endpoints
# =======================================================

#=======================================================
# Gateway Endpoints
#=======================================================

  EndpointS3:
    Type: AWS::EC2::VPCEndpoint    
    Properties:
      VpcId: !Ref VPC
      VpcEndpointType: Gateway
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      RouteTableIds:
        - !Ref 'PrivateSubnet1RouteTable'
        - !Ref 'PrivateSubnet2RouteTable'
        - !Ref 'PrivateSubnet3RouteTable'
        - !Ref 'PrivateSubnet4RouteTable'        



######  Outputs ########

Outputs:

  VPCID:
    Description: The ID of the VPC
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPCID'
  PrivateSubnet1ID:
    Description: The ID of Private Subnet 1
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet1ID'
  PrivateSubnet2ID:
    Description: The ID of Private Subnet 2
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet2ID'
  PrivateSubnet3ID:
    Description: The ID of Private Subnet 3
    Value: !Ref PrivateSubnet3
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet3ID'
  PrivateSubnet4ID:
    Description: The ID of Private Subnet 4
    Value: !Ref PrivateSubnet4
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet4ID'
  PrivateIPV6Subnet1ID:
    Description: The ID of IPv6 Private Subnet 1
    Value: !Ref IPv6PrivateSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PrivateIPv6Subnet1ID'
  PrivateIPV6Subnet2ID:
    Description: The ID of IPv6 Private Subnet 2
    Value: !Ref IPv6PrivateSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PrivateIPv6Subnet2ID'
  PrivateIPV6Subnet3ID:
    Description: The ID of IPv6 Private Subnet 3
    Value: !Ref IPv6PrivateSubnet3
    Export:
      Name: !Sub '${AWS::StackName}-PrivateIPv6Subnet3ID' 
  PrivateIPV6Subnet4ID:
    Description: The ID of IPv6 Private Subnet 4
    Value: !Ref IPv6PrivateSubnet4
    Export:
      Name: !Sub '${AWS::StackName}-PrivateIPv6Subnet4ID'               
  PublicSubnet1ID:
    Description: The ID of Public Subnet 1
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1ID'
  PublicSubnet2ID:
    Description: The ID of Public Subnet 2
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2ID'
  PublicSubnet3ID:
    Description: The ID of Public Subnet 3
    Value: !Ref PublicSubnet3
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet3ID'  
  PublicSubnet4ID:
    Description: The ID of Public Subnet 4
    Value: !Ref PublicSubnet4
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet4ID'  